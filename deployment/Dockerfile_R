FROM quay.io/jupyter/r-notebook:python-3.12.10

# Good to have for compiled R pkgs:
RUN pip install --no-cache-dir pdm
USER root
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    libcurl4-openssl-dev \
    libssl-dev \
    libudunits2-dev \
    libgdal-dev \
    libgeos-dev \
    libproj-dev \
    libfontconfig1-dev \
    libfreetype6-dev \
    libfribidi-dev \
    libharfbuzz-dev \
    libpng-dev \
    libtiff5-dev \
    libjpeg-dev \
    libxml2-dev \
    zlib1g-dev \
    pandoc \
    curl \
    cmake \
    && rm -rf /var/lib/apt/lists/*

# Quarto
RUN curl -LO https://quarto.org/download/latest/quarto-linux-amd64.deb \
    && dpkg -i quarto-linux-amd64.deb \
    && rm quarto-linux-amd64.deb

# Optional but helpful: pin CRAN mirror globally for all R sessions
RUN bash -lc 'echo "options(repos=c(CRAN=\"https://cran.rstudio.com/\"))" >> /opt/conda/lib/R/etc/Rprofile.site'


COPY ../pyproject.toml /home/${NB_USER}/deps/pyproject.toml
RUN chown -R ${NB_UID}:${NB_GID} /home/${NB_USER}/deps
USER ${NB_UID}

WORKDIR /home/${NB_USER}/deps 

RUN pdm config python.use_venv false && \
    pdm lock && \
    pdm export --without-hashes --format requirements | pip install -r /dev/stdin

WORKDIR /home/${NB_USER}
RUN rm -rf deps
# ---- R deps: install system-wide into the Conda R site-library ----
USER root
# Make sure the site-library is writable during build (it is for root)
# Install in one shot; use Ncpus and disable interactive updates
RUN R -e 'options(Ncpus = max(1L, parallel::detectCores()-1L)); install.packages(c( \
    "rstac","tidyverse","stars","terra","httr2","fs","lobstr","BiocManager" \
    ), dependencies = TRUE)'
RUN R -e 'BiocManager::install("Rarr", update = FALSE, ask = FALSE)'

# Register IRkernel for all users so Jupyter sees the R kernel
RUN R -e 'install.packages("IRkernel"); IRkernel::installspec(user = FALSE)'

# Jupyter stack helper to fix permissions for all users
RUN fix-permissions /opt/conda \
    && fix-permissions /home/${NB_USER}

# Helpful for Quarto to find the right jupyter/python
ENV QUARTO_JUPYTER=/opt/conda/bin/jupyter \
    QUARTO_PYTHON=/opt/conda/bin/python

USER ${NB_UID}
WORKDIR /home/${NB_USER}
